#!/usr/bin/make -f

INSTALLDIR := /tmp/@OECP_NAME@

build: build-stamp
	@CMAKE_MAKE_PROGRAM@ segw -j4 -C @PROJECT_BINARY_DIR@

build-stamp:
	touch build-stamp

clean:
#	make -C @PROJECT_BINARY_DIR@ clean
	rm -f build-stamp
	rm -rf $(INSTALLDIR)

install: build
	install -d $(INSTALLDIR)/usr/local/lib
#	install -m 755 @PROJECT_BINARY_DIR@/lib*.so $(INSTALLDIR)/usr/local/lib
	install -m 755 @PROJECT_BINARY_DIR@/lib/ipt/protocol/libsmf_protocol_ipt.so $(INSTALLDIR)/usr/local/lib
	install -m 755 @PROJECT_BINARY_DIR@/lib/ipt/bus/libsmf_bus_ipt.so $(INSTALLDIR)/usr/local/lib
	install -m 755 @PROJECT_BINARY_DIR@/lib/mbus/protocol/libsmf_protocol_mbus.so $(INSTALLDIR)/usr/local/lib
	install -m 755 @PROJECT_BINARY_DIR@/lib/hci/protocol/libsmf_protocol_hci.so $(INSTALLDIR)/usr/local/lib
	install -m 755 @PROJECT_BINARY_DIR@/lib/info/libsmf_info.so $(INSTALLDIR)/usr/local/lib
	install -m 755 @PROJECT_BINARY_DIR@/lib/sml/protocol/libsmf_protocol_sml.so $(INSTALLDIR)/usr/local/lib
	install -m 755 @PROJECT_BINARY_DIR@/lib/sml/bus/libsmf_bus_sml.so $(INSTALLDIR)/usr/local/lib
	install -m 755 @PROJECT_BINARY_DIR@/lib/serial/bus/libsmf_bus_serial.so $(INSTALLDIR)/usr/local/lib

	install -m 755 @__cyng_async@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_csv@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_domain@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_log@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_parser@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_store@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_vm@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_core@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_db@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_io@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_rnd@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_sys@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_xml@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_json@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_meta@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_sql@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @__cyng_table@ $(INSTALLDIR)/usr/local/lib
	install -m 755 @CRYPT_BUILD@/libcrypto.so $(INSTALLDIR)/usr/local/lib

	# maybe another path is required to build in a docker environment
	install -m 755 @Boost_LIBRARY_DIRS@/libboost_filesystem.so.1.75.0 $(INSTALLDIR)/usr/local/lib/libboost_filesystem.so.1.75.0
	install -m 755 @Boost_LIBRARY_DIRS@/libboost_program_options.so.1.75.0 $(INSTALLDIR)/usr/local/lib/libboost_program_options.so.1.75.0
	install -m 755 @Boost_LIBRARY_DIRS@/libboost_random.so.1.75.0 $(INSTALLDIR)/usr/local/lib/libboost_random.so.1.75.0
	install -m 755 @Boost_LIBRARY_DIRS@/libboost_system.so.1.75.0 $(INSTALLDIR)/usr/local/lib/libboost_system.so.1.75.0
	install -m 755 @Boost_LIBRARY_DIRS@/libboost_thread.so.1.75.0 $(INSTALLDIR)/usr/local/lib/libboost_thread.so.1.75.0

	install -d $(INSTALLDIR)/usr/local/sbin
	install -m 755 @PROJECT_BINARY_DIR@/nodes/ipt/segw/segw $(INSTALLDIR)/usr/local/sbin
	install -m 755 @CYNG_ROOT_DEV@/@CYNG_ROOT_BUILD_SUBDIR@/sqlite3 $(INSTALLDIR)/usr/local/sbin

	install -d $(INSTALLDIR)/usr/local/etc/smf
	install -m 644 @PROJECT_BINARY_DIR@/config/segw_v0.8.cfg $(INSTALLDIR)/usr/local/etc

#Any .service file found in /usr/local/lib/systemd/system is hooked into the systemd infrastructure on startup and will be executed.
	install -d $(INSTALLDIR)/usr/local/lib/systemd/system
	install -m 644 @PROJECT_BINARY_DIR@/config/segw.service $(INSTALLDIR)/usr/local/lib/systemd/system

.PHONY: build clean install
