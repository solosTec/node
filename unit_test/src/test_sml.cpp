#ifdef STAND_ALONE
#define BOOST_TEST_MODULE unit_test
#endif

#include <boost/test/unit_test.hpp>

#include <smf/obis/db.h>
#include <smf/obis/defs.h>
#include <smf/obis/list.h>
#include <smf/sml/generator.h>
#include <smf/sml/msg.h>
#include <smf/sml/parser.h>
#include <smf/sml/reader.h>
#include <smf/sml/select.h>
#include <smf/sml/status.h>
#include <smf/sml/tokenizer.h>
#include <smf/sml/unpack.h>
#include <smf/sml/value.hpp>
#include <smf/sml/writer.hpp>

#include <cyng/io/ostream.h>
#include <cyng/io/serialize.h>
#include <cyng/obj/container_factory.hpp>
#include <cyng/obj/value_cast.hpp>
#include <cyng/parse/buffer.h>
#include <cyng/parse/string.h>

#include <fstream>
#include <iostream>

#ifdef _DEBUG
#include <cyng/io/hex_dump.hpp>
#include <iostream>
#include <sstream>
#endif

BOOST_AUTO_TEST_SUITE(sml_suite)

BOOST_AUTO_TEST_CASE(tokenizer) {
    std::ifstream ifile("..\\..\\unit_test\\assets\\smf--SML-202012T071425-power@solostec8bbb6264-bc4a4b92.sml", std::ios::binary);
    BOOST_CHECK(ifile.is_open());
    if (ifile.is_open()) {
        //	dont skip whitespaces
        ifile >> std::noskipws;
        smf::sml::tokenizer p([](smf::sml::sml_type type, std::size_t size, cyng::buffer_t data) {
            std::cout << smf::sml::get_name(type) << '[' << size << '/' << data.size() << ']' << std::endl;
        });
        p.read(std::istream_iterator<char>(ifile), std::istream_iterator<char>());
    }
}

BOOST_AUTO_TEST_CASE(parser) {
    std::ifstream ifile("..\\..\\unit_test\\assets\\smf--SML-202012T071425-power@solostec8bbb6264-bc4a4b92.sml", std::ios::binary);
    BOOST_CHECK(ifile.is_open());
    if (ifile.is_open()) {
        //	dont skip whitespaces
        ifile >> std::noskipws;
        smf::sml::parser p(
            [](std::string trx, std::uint8_t, std::uint8_t, smf::sml::msg_type type, cyng::tuple_t msg, std::uint16_t) {
                std::cout << "> " << smf::sml::get_name(type) << ": " << trx << ", " << msg << std::endl;
            });

        //	});
        p.read(std::istream_iterator<char>(ifile), std::istream_iterator<char>());
    }
}

BOOST_AUTO_TEST_CASE(login) {
    auto const inp = cyng::make_buffer({
        0x1b,
        0x1b,
        0x1b,
        0x1b,
        0x01,
        0x01,
        0x01,
        0x01,
        /* trailer */ 0x76,
        0x81,
        0x05,
        0x32,
        0x31,
        0x30,
        0x34,
        0x32, // ........ v..21042
        0x37,
        0x31,
        0x36,
        0x31,
        0x37,
        0x30,
        0x34,
        0x36,
        0x38,
        0x36,
        0x35,
        0x36,
        0x2d,
        0x31,
        0x62,
        0x00, // 71617046 8656-1b.
        0x62,
        0x00,
        0x72,
        0x63,
        0x01,
        0x00,
        0x77,
        0x01,
        0x07,
        0x00,
        0x50,
        0x56,
        0xc0,
        0x00,
        0x08,
        0x0f, // b.rc..w. ..PV....
        0x32,
        0x30,
        0x32,
        0x31,
        0x30,
        0x34,
        0x32,
        0x37,
        0x31,
        0x36,
        0x31,
        0x37,
        0x30,
        0x34,
        0x08,
        0x05, // 20210427 161704..
        0x00,
        0x15,
        0x3b,
        0x01,
        0xec,
        0x46,
        0x09,
        0x6f,
        0x70,
        0x65,
        0x72,
        0x61,
        0x74,
        0x6f,
        0x72,
        0x09, // ..;..F.o perator.
        0x6f,
        0x70,
        0x65,
        0x72,
        0x61,
        0x74,
        0x6f,
        0x72,
        0x01,
        0x63,
        0x8d,
        0x3b,
        0x00,
        0x76,
        0x81,
        0x05, // operator .c.;.v..
        0x32,
        0x31,
        0x30,
        0x34,
        0x32,
        0x37,
        0x31,
        0x36,
        0x31,
        0x37,
        0x30,
        0x34,
        0x36,
        0x38,
        0x36,
        0x35, // 21042716 17046865
        0x36,
        0x2d,
        0x32,
        0x62,
        0x01,
        0x62,
        0x00,
        0x72,
        0x63,
        0x05,
        0x00,
        0x75,
        0x08,
        0x05,
        0x00,
        0x15, // 6-2b.b.r c..u....
        0x3b,
        0x01,
        0xec,
        0x46,
        0x09,
        0x6f,
        0x70,
        0x65,
        0x72,
        0x61,
        0x74,
        0x6f,
        0x72,
        0x09,
        0x6f,
        0x70, // ;..F.ope rator.op
        0x65,
        0x72,
        0x61,
        0x74,
        0x6f,
        0x72,
        0x71,
        0x07,
        0x81,
        0x00,
        0x60,
        0x05,
        0x00,
        0x00,
        0x01,
        0x62, // eratorq. ..`....b
        0x8d,
        0x00,
        0x76,
        0x81,
        0x05,
        0x32,
        0x31,
        0x30,
        0x34,
        0x32,
        0x37,
        0x31,
        0x36,
        0x31,
        0x37,
        0x30, // ..v..210 42716170
        0x34,
        0x36,
        0x38,
        0x36,
        0x35,
        0x36,
        0x2d,
        0x33,
        0x62,
        0x02,
        0x62,
        0x00,
        0x72,
        0x63,
        0x05,
        0x00, // 468656-3 b.b.rc..
        0x75,
        0x08,
        0x05,
        0x00,
        0x15,
        0x3b,
        0x01,
        0xec,
        0x46,
        0x09,
        0x6f,
        0x70,
        0x65,
        0x72,
        0x61,
        0x74, // u....;.. F.operat
        0x6f,
        0x72,
        0x09,
        0x6f,
        0x70,
        0x65,
        0x72,
        0x61,
        0x74,
        0x6f,
        0x72,
        0x71,
        0x07,
        0x81,
        0x81,
        0xc7, // or.opera torq....
        0x82,
        0x01,
        0xff,
        0x01,
        0x63,
        0xb5,
        0x0f,
        0x00,
        0x76,
        0x81,
        0x05,
        0x32,
        0x31,
        0x30,
        0x34,
        0x32, // ....c... v..21042
        0x37,
        0x31,
        0x36,
        0x31,
        0x37,
        0x30,
        0x34,
        0x36,
        0x38,
        0x36,
        0x35,
        0x36,
        0x2d,
        0x34,
        0x62,
        0x00, // 71617046 8656-4b.
        0x62,
        0x00,
        0x72,
        0x63,
        0x02,
        0x00,
        0x71,
        0x01,
        0x63,
        0x37,
        0x58,
        0x00,
        /* post */ 0x1b,
        0x1b,
        0x1b,
        0x1b, // b.rc..q. c7X.....
        0x1a,
        0x00,
        0xf8,
        0xad //                                      ....
    });

    smf::sml::unpack p(
        [](std::string trx, std::uint8_t, std::uint8_t, smf::sml::msg_type type, cyng::tuple_t msg, std::uint16_t crc) {
            std::cout << "> " << smf::sml::get_name(type) << ": " << trx << ", " << msg << std::endl;
        });
    p.read(std::begin(inp), std::end(inp));
    BOOST_REQUIRE(p.get_parser().is_closed());

    /*
    ### Message ###
    76                                                SML_Message(Sequence):
      810532313034323731363137303436383635362D31      transactionId: 21042716170468656-1
      6200                                            groupNo: 0
      6200                                            abortOnError: 0
      72                                              messageBody(Choice):
            630100                                        messageBody: 256 => SML_PublicOpen_Req (0x00000100)
            77                                            SML_PublicOpen_Req(Sequence):
              01                                          codepage: not set
              07005056C00008                              clientId: 00 50 56 C0 00 08
              0F3230323130343237313631373034              reqFileId: 20210427161704
              080500153B01EC46                            serverId: 05 00 15 3B 01 EC 46
              096F70657261746F72                          username: operator
              096F70657261746F72                          password: operator
              01                                          sml_Version: not set
      638D3B                                          crc16: 36155
      00                                              endOfSmlMsg: 00
    ### Message ###
    76                                                SML_Message(Sequence):
      810532313034323731363137303436383635362D32      transactionId: 21042716170468656-2
      6201                                            groupNo: 1
      6200                                            abortOnError: 0
      72                                              messageBody(Choice):
            630500                                        messageBody: 1280 => SML_GetProcParameter_Req (0x00000500)
            75                                            SML_GetProcParameter_Req(Sequence):
              080500153B01EC46                            serverId: 05 00 15 3B 01 EC 46
              096F70657261746F72                          username: operator
              096F70657261746F72                          password: operator
              71                                          parameterTreePath(SequenceOf):
                    07810060050000                            path_Entry: 81 00 60 05 00 00
              01                                          attribute: not set
      628D                                            crc16: 141
      00                                              endOfSmlMsg: 00
    ### Message ###
    76                                                SML_Message(Sequence):
      810532313034323731363137303436383635362D33      transactionId: 21042716170468656-3
      6202                                            groupNo: 2
      6200                                            abortOnError: 0
      72                                              messageBody(Choice):
            630500                                        messageBody: 1280 => SML_GetProcParameter_Req (0x00000500)
            75                                            SML_GetProcParameter_Req(Sequence):
              080500153B01EC46                            serverId: 05 00 15 3B 01 EC 46
              096F70657261746F72                          username: operator
              096F70657261746F72                          password: operator
              71                                          parameterTreePath(SequenceOf):
                    078181C78201FF                            path_Entry: 81 81 C7 82 01 FF
              01                                          attribute: not set
      63B50F                                          crc16: 46351
      00                                              endOfSmlMsg: 00
    ### Message ###
    76                                                SML_Message(Sequence):
      810532313034323731363137303436383635362D34      transactionId: 21042716170468656-4
      6200                                            groupNo: 0
      6200                                            abortOnError: 0
      72                                              messageBody(Choice):
            630200                                        messageBody: 512 => SML_PublicClose_Req (0x00000200)
            71                                            SML_PublicClose_Req(Sequence):
              01                                          globalSignature: not set
      633758                                          crc16: 14168
      00                                              endOfSmlMsg: 00
    */
}

BOOST_AUTO_TEST_CASE(value) {
    auto const tpl_01 = smf::sml::make_value(1);
    BOOST_REQUIRE_EQUAL(tpl_01.size(), 2);

    auto const tpl_02 = smf::sml::make_value("hello");
    BOOST_REQUIRE_EQUAL(tpl_02.size(), 2);

    const char s[6] = {'w', 'o', 'r', 'l', 'd', '!'};
    auto const tpl_03 = smf::sml::make_value(s);
    BOOST_REQUIRE_EQUAL(tpl_03.size(), 2);

    auto const key = cyng::make_aes_key<cyng::crypto::aes128_size>(cyng::hex_to_buffer("6E3272357538782F413F4428472B4B62"));
    auto const tpl_04 = smf::sml::make_value(key);
    BOOST_REQUIRE_EQUAL(tpl_04.size(), 2);
}

BOOST_AUTO_TEST_CASE(get_profile_list_response) {
    auto const inp = cyng::make_buffer({
        /* [0000] */ 0x1b,
        0x1b,
        0x1b,
        0x1b,
        0x01,
        0x01,
        0x01,
        0x01,
        0x76,
        0x07,
        0x34,
        0x33,
        0x36,
        0x38,
        0x35,
        0x38, // ........ v.436858
        /* [0010] */ 0x62,
        0x00,
        0x62,
        0x00,
        0x72,
        0x63,
        0x01,
        0x01,
        0x76,
        0x01,
        0x08,
        0x05,
        0x00,
        0x15,
        0x3b,
        0x01, // b.b.rc.. v.....;.
        /* [0020] */ 0xec,
        0x46,
        0x07,
        0x34,
        0x33,
        0x36,
        0x38,
        0x35,
        0x37,
        0x0a,
        0x01,
        0xe6,
        0x1e,
        0x57,
        0x14,
        0x06, // .F.43685 7....W..
        /* [0030] */ 0x21,
        0x36,
        0x03,
        0x01,
        0x01,
        0x63,
        0x59,
        0xb7,
        0x00, // !6...cY. .

        /* [0000] */ 0x76,
        0x07,
        0x34,
        0x33,
        0x36,
        0x38,
        0x35,
        0x39,
        0x62,
        0x00,
        0x62,
        0x00,
        0x72,
        0x63,
        0x04,
        0x01, // v.436859 b.b.rc..
        /* [0010] */ 0x79,
        0x0a,
        0x01,
        0xe6,
        0x1e,
        0x57,
        0x14,
        0x06,
        0x21,
        0x36,
        0x03,
        0x72,
        0x62,
        0x02,
        0x65,
        0x60, // y....W.. !6.rb.e`
        /* [0020] */ 0xa1,
        0x4f,
        0xd5,
        0x62,
        0x00,
        0x71,
        0x07,
        0x81,
        0x81,
        0xc7,
        0x86,
        0x11,
        0xff,
        0x72,
        0x62,
        0x01, // .O.b.q.. .....rb.
        /* [0030] */ 0x65,
        0x0a,
        0xe6,
        0xfe,
        0xd6,
        0x62,
        0x00,
        0x77,
        0x75,
        0x07,
        0x00,
        0x00,
        0x60,
        0x01,
        0x01,
        0xff, // e....b.w u...`...
        /* [0040] */ 0x62,
        0xff,
        0x52,
        0x00,
        0x09,
        0xe6,
        0x1e,
        0x57,
        0x14,
        0x06,
        0x21,
        0x36,
        0x03,
        0x01,
        0x75,
        0x07, // b.R....W ..!6..u.
        /* [0050] */ 0x00,
        0x00,
        0x61,
        0x61,
        0x00,
        0xff,
        0x62,
        0xff,
        0x52,
        0x00,
        0x62,
        0x00,
        0x01,
        0x75,
        0x07,
        0x07, // ..aa..b. R.b..u..
        /* [0060] */ 0x00,
        0x03,
        0x01,
        0x00,
        0x01,
        0x62,
        0x0d,
        0x52,
        0xfe,
        0x55,
        0x00,
        0x18,
        0xe7,
        0x5d,
        0x01,
        0x75, // .....b.R .U...].u
        /* [0070] */ 0x07,
        0x07,
        0x00,
        0x03,
        0x01,
        0x00,
        0xff,
        0x62,
        0x0d,
        0x52,
        0xfe,
        0x55,
        0x00,
        0x18,
        0xe7,
        0x5d, // .......b .R.U...]
        /* [0080] */ 0x01,
        0x75,
        0x07,
        0x81,
        0x81,
        0xc7,
        0x82,
        0x03,
        0xff,
        0x62,
        0xff,
        0x52,
        0x00,
        0x04,
        0x47,
        0x57, // .u...... .b.R..GW
        /* [0090] */ 0x46,
        0x01,
        0x75,
        0x07,
        0x01,
        0x00,
        0x00,
        0x09,
        0x0b,
        0x00,
        0x62,
        0x07,
        0x52,
        0x00,
        0x65,
        0x60, // F.u..... ..b.R.e`
        /* [00a0] */ 0xa1,
        0x4b,
        0xa7,
        0x01,
        0x75,
        0x07,
        0x81,
        0x06,
        0x2b,
        0x07,
        0x00,
        0x00,
        0x62,
        0xff,
        0x52,
        0x00, // .K..u... +...b.R.
        /* [00b0] */ 0x55,
        0xff,
        0xff,
        0xff,
        0xb1,
        0x01,
        0x01,
        0x01,
        0x63,
        0xee,
        0xb2,
        0x00, // U....... c...

        /* [0000] */ 0x76,
        0x07,
        0x34,
        0x33,
        0x36,
        0x38,
        0x35,
        0x39,
        0x62,
        0x00,
        0x62,
        0x00,
        0x72,
        0x63,
        0x04,
        0x01, // v.436859 b.b.rc..
        /* [0010] */ 0x79,
        0x0a,
        0x01,
        0xe6,
        0x1e,
        0x57,
        0x14,
        0x06,
        0x21,
        0x36,
        0x03,
        0x72,
        0x62,
        0x02,
        0x65,
        0x60, // y....W.. !6.rb.e`
        /* [0020] */ 0xa1,
        0x4f,
        0xd5,
        0x62,
        0x00,
        0x71,
        0x07,
        0x81,
        0x81,
        0xc7,
        0x86,
        0x11,
        0xff,
        0x72,
        0x62,
        0x01, // .O.b.q.. .....rb.
        /* [0030] */ 0x65,
        0x0a,
        0xe7,
        0x02,
        0x96,
        0x62,
        0x00,
        0x77,
        0x75,
        0x07,
        0x00,
        0x00,
        0x60,
        0x01,
        0x01,
        0xff, // e....b.w u...`...
        /* [0040] */ 0x62,
        0xff,
        0x52,
        0x00,
        0x09,
        0xe6,
        0x1e,
        0x57,
        0x14,
        0x06,
        0x21,
        0x36,
        0x03,
        0x01,
        0x75,
        0x07, // b.R....W ..!6..u.
        /* [0050] */ 0x00,
        0x00,
        0x61,
        0x61,
        0x00,
        0xff,
        0x62,
        0xff,
        0x52,
        0x00,
        0x62,
        0x00,
        0x01,
        0x75,
        0x07,
        0x07, // ..aa..b. R.b..u..
        /* [0060] */ 0x00,
        0x03,
        0x01,
        0x00,
        0x01,
        0x62,
        0x0d,
        0x52,
        0xfe,
        0x55,
        0x00,
        0x18,
        0xe7,
        0x5d,
        0x01,
        0x75, // .....b.R .U...].u
        /* [0070] */ 0x07,
        0x07,
        0x00,
        0x03,
        0x01,
        0x00,
        0xff,
        0x62,
        0x0d,
        0x52,
        0xfe,
        0x55,
        0x00,
        0x18,
        0xe7,
        0x5d, // .......b .R.U...]
        /* [0080] */ 0x01,
        0x75,
        0x07,
        0x81,
        0x81,
        0xc7,
        0x82,
        0x03,
        0xff,
        0x62,
        0xff,
        0x52,
        0x00,
        0x04,
        0x47,
        0x57, // .u...... .b.R..GW
        /* [0090] */ 0x46,
        0x01,
        0x75,
        0x07,
        0x01,
        0x00,
        0x00,
        0x09,
        0x0b,
        0x00,
        0x62,
        0x07,
        0x52,
        0x00,
        0x65,
        0x60, // F.u..... ..b.R.e`
        /* [00a0] */ 0xa1,
        0x4f,
        0x67,
        0x01,
        0x75,
        0x07,
        0x81,
        0x06,
        0x2b,
        0x07,
        0x00,
        0x00,
        0x62,
        0xff,
        0x52,
        0x00, // .Og.u... +...b.R.
        /* [00b0] */ 0x55,
        0xff,
        0xff,
        0xff,
        0xae,
        0x01,
        0x01,
        0x01,
        0x63,
        0x1b,
        0xd2,
        0x00 // U....... c...
    });

    smf::sml::unpack p(
        [](std::string trx, std::uint8_t, std::uint8_t, smf::sml::msg_type type, cyng::tuple_t msg, std::uint16_t crc) {
            std::cout << "> " << smf::sml::get_name(type) << ": " << trx << ", " << msg << std::endl;
            if (type == smf::sml::msg_type::GET_PROFILE_LIST_RESPONSE) {
                auto const [s, p, act, reg, val, stat, list] = smf::sml::read_get_profile_list_response(msg);
                // auto const r = smf::sml::read_get_profile_list_response(msg);
                for (auto const &ro : list) {
                    std::cout << ">> " << ro.first << ": " << ro.second << std::endl;
                }
            }
        });
    p.read(std::begin(inp), std::end(inp));
    // BOOST_REQUIRE(p.get_parser().is_closed());
}

BOOST_AUTO_TEST_CASE(get_proc_param_response) {

    //  contains a long octet: 06e55b633481f7bb072957eabcf110c972e86691c3cfedabe088024bffe42f23
    // and a sequence of length "F104" == 20dec
    //### Message ###
    // 76                                                SML_Message(Sequence):
    //  0A323639353535302D34                            transactionId: 2695550-4
    //  6203                                            groupNo: 3
    //  6200                                            abortOnError: 0
    //  72                                              messageBody(Choice):
    //    630501                                        messageBody: 1281 => SML_GetProcParameter_Res (0x00000501)
    //    73                                            SML_GetProcParameter_Res(Sequence):
    //      080500153B01EC46                            serverId: 05 00 15 3B 01 EC 46
    //      71                                          parameterTreePath(SequenceOf):
    //        0781818160FFFF                            path_Entry: ___`__
    //      73                                          parameterTree(Sequence):
    //        0781818160FFFF                            parameterName: ___`__
    //        01                                        parameterValue: not set
    //        77                                        child_List(SequenceOf):
    //          73                                      tree_Entry(Sequence):
    //            078181816001FF                        parameterName: 81 81 81 60 01 FF
    //            01                                    parameterValue: not set
    //            01                                    child_List: not set
    //          73                                      tree_Entry(Sequence):
    //            078181816002FF                        parameterName: 81 81 81 60 02 FF
    //            01                                    parameterValue: not set
    //            01                                    child_List: not set
    //          73                                      tree_Entry(Sequence):
    //            078181816003FF                        parameterName: 81 81 81 60 03 FF
    //            01                                    parameterValue: not set
    //            71                                    child_List(SequenceOf):
    //              73                                  tree_Entry(Sequence):
    //                07818181600301                    parameterName: 81 81 81 60 03 01
    //                01                                parameterValue: not set
    //                F104                              child_List(SequenceOf):
    //                  73                              tree_Entry(Sequence):
    //                    0781818161FFFF                parameterName: ___a__
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      096F70657261746F72          smlValue: operator
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    0781818162FFFF                parameterName: ___b__
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      840230366535356236333334383166376262303732393537656162636631313063393732653836363931633363666564616265303838303234626666653432663233smlValue:
    //                      06e55b633481f7bb072957eabcf110c972e86691c3cfedabe088024bffe42f23
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    0781818163FFFF                parameterName: ___c__
    //                    01                            parameterValue: not set
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640111                parameterName: 81 81 81 64 01 11
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      0A01E61E571406213603        smlValue: 01 E6 1E 57 14 06 21 36 03
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640110                parameterName: 81 81 81 64 01 10
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      07005056C00008              smlValue: 00 50 56 C0 00 08
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    0781818164010F                parameterName: 81 81 81 64 01 0F
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      0A01E61E29436587BF03        smlValue: 01 E6 1E 29 43 65 87 BF 03
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    0781818164010E                parameterName: 81 81 81 64 01 0E
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      0A01E61E130900163C07        smlValue: 01 E6 1E 13 09 00 16 3C 07
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    0781818164010D                parameterName: 81 81 81 64 01 0D
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      0A01A815743145040102        smlValue: 01 A8 15 74 31 45 04 01 02
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    0781818164010C                parameterName: 81 81 81 64 01 0C
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      0A012423021590200786        smlValue: 01 24 23 02 15 90 20 07 86
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    0781818164010B                parameterName: 81 81 81 64 01 0B
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      050AB00001                  smlValue: 0A B0 00 01
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    0781818164010A                parameterName: 81 81 81 64 01 0A
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      0A01FA306DD7FAE00102        smlValue: 01 FA 30 6D D7 FA E0 01 02
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640109                parameterName: 81 81 81 64 01 09
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      050AE00001                  smlValue: 0A E0 00 01
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640108                parameterName: 81 81 81 64 01 08
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      050AD00001                  smlValue: 0A D0 00 01
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640107                parameterName: 81 81 81 64 01 07
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      050AA00001                  smlValue: 0A A0 00 01
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640106                parameterName: 81 81 81 64 01 06
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      050A000004                  smlValue: 0A 00 00 04
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640105                parameterName: 81 81 81 64 01 05
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      050A000003                  smlValue: 0A 00 00 03
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640104                parameterName: 81 81 81 64 01 04
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      050A000002                  smlValue: 0A 00 00 02
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640103                parameterName: 81 81 81 64 01 03
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      050A000001                  smlValue: 0A 00 00 01
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640102                parameterName: 81 81 81 64 01 02
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      093034303435303537          smlValue: 04045057
    //                    01                            child_List: not set
    //                  73                              tree_Entry(Sequence):
    //                    07818181640101                parameterName: 81 81 81 64 01 01
    //                    72                            parameterValue(Choice):
    //                      6201                        parameterValue: 1 => smlValue (0x01)
    //                      080500153B01EC46            smlValue: 05 00 15 3B 01 EC 46
    //                    01                            child_List: not set
    //          73                                      tree_Entry(Sequence):
    //            078181816004FF                        parameterName: 81 81 81 60 04 FF
    //            01                                    parameterValue: not set
    //            01                                    child_List: not set
    //          73                                      tree_Entry(Sequence):
    //            078181816005FF                        parameterName: 81 81 81 60 05 FF
    //            01                                    parameterValue: not set
    //            01                                    child_List: not set
    //          73                                      tree_Entry(Sequence):
    //            078181816006FF                        parameterName: 81 81 81 60 06 FF
    //            01                                    parameterValue: not set
    //            01                                    child_List: not set
    //          73                                      tree_Entry(Sequence):
    //            078181816008FF                        parameterName: 81 81 81 60 08 FF
    //            01                                    parameterValue: not set
    //            01                                    child_List: not set
    //  63E8B8                                          crc16: 59576
    //  00                                              endOfSmlMsg: 00

    auto const inp = cyng::make_buffer(
        {0x76, 0x0a, 0x32, 0x36, 0x39, 0x35, 0x35, 0x35, 0x30, 0x2d, 0x34, 0x62, 0x03, 0x62, 0x00, 0x72, 0x63, 0x05, 0x01, 0x73,
         0x08, 0x05, 0x00, 0x15, 0x3b, 0x01, 0xec, 0x46, 0x71, 0x07, 0x81, 0x81, 0x81, 0x60, 0xff, 0xff, 0x73, 0x07, 0x81, 0x81,
         0x81, 0x60, 0xff, 0xff, 0x01, 0x77, 0x73, 0x07, 0x81, 0x81, 0x81, 0x60, 0x01, 0xff, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81,
         0x81, 0x60, 0x02, 0xff, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x60, 0x03, 0xff, 0x01, 0x71, 0x73, 0x07, 0x81, 0x81,
         0x81, 0x60, 0x03, 0x01, 0x01, 0xf1, 0x04, 0x73, 0x07, 0x81, 0x81, 0x81, 0x61, 0xff, 0xff, 0x72, 0x62, 0x01, 0x09, 0x6f,
         0x70, 0x65, 0x72, 0x61, 0x74, 0x6f, 0x72, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x62, 0xff, 0xff, 0x72, 0x62, 0x01, 0x84,
         0x02, 0x30, 0x36, 0x65, 0x35, 0x35, 0x62, 0x36, 0x33, 0x33, 0x34, 0x38, 0x31, 0x66, 0x37, 0x62, 0x62, 0x30, 0x37, 0x32,
         0x39, 0x35, 0x37, 0x65, 0x61, 0x62, 0x63, 0x66, 0x31, 0x31, 0x30, 0x63, 0x39, 0x37, 0x32, 0x65, 0x38, 0x36, 0x36, 0x39,
         0x31, 0x63, 0x33, 0x63, 0x66, 0x65, 0x64, 0x61, 0x62, 0x65, 0x30, 0x38, 0x38, 0x30, 0x32, 0x34, 0x62, 0x66, 0x66, 0x65,
         0x34, 0x32, 0x66, 0x32, 0x33, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x63, 0xff, 0xff, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81,
         0x81, 0x64, 0x01, 0x11, 0x72, 0x62, 0x01, 0x0a, 0x01, 0xe6, 0x1e, 0x57, 0x14, 0x06, 0x21, 0x36, 0x03, 0x01, 0x73, 0x07,
         0x81, 0x81, 0x81, 0x64, 0x01, 0x10, 0x72, 0x62, 0x01, 0x07, 0x00, 0x50, 0x56, 0xc0, 0x00, 0x08, 0x01, 0x73, 0x07, 0x81,
         0x81, 0x81, 0x64, 0x01, 0x0f, 0x72, 0x62, 0x01, 0x0a, 0x01, 0xe6, 0x1e, 0x29, 0x43, 0x65, 0x87, 0xbf, 0x03, 0x01, 0x73,
         0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x0e, 0x72, 0x62, 0x01, 0x0a, 0x01, 0xe6, 0x1e, 0x13, 0x09, 0x00, 0x16, 0x3c, 0x07,
         0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x0d, 0x72, 0x62, 0x01, 0x0a, 0x01, 0xa8, 0x15, 0x74, 0x31, 0x45, 0x04,
         0x01, 0x02, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x0c, 0x72, 0x62, 0x01, 0x0a, 0x01, 0x24, 0x23, 0x02, 0x15,
         0x90, 0x20, 0x07, 0x86, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x0b, 0x72, 0x62, 0x01, 0x05, 0x0a, 0xb0, 0x00,
         0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x0a, 0x72, 0x62, 0x01, 0x0a, 0x01, 0xfa, 0x30, 0x6d, 0xd7, 0xfa,
         0xe0, 0x01, 0x02, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x09, 0x72, 0x62, 0x01, 0x05, 0x0a, 0xe0, 0x00, 0x01,
         0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x08, 0x72, 0x62, 0x01, 0x05, 0x0a, 0xd0, 0x00, 0x01, 0x01, 0x73, 0x07,
         0x81, 0x81, 0x81, 0x64, 0x01, 0x07, 0x72, 0x62, 0x01, 0x05, 0x0a, 0xa0, 0x00, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81,
         0x64, 0x01, 0x06, 0x72, 0x62, 0x01, 0x05, 0x0a, 0x00, 0x00, 0x04, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x05,
         0x72, 0x62, 0x01, 0x05, 0x0a, 0x00, 0x00, 0x03, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x04, 0x72, 0x62, 0x01,
         0x05, 0x0a, 0x00, 0x00, 0x02, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x03, 0x72, 0x62, 0x01, 0x05, 0x0a, 0x00,
         0x00, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x02, 0x72, 0x62, 0x01, 0x09, 0x30, 0x34, 0x30, 0x34, 0x35,
         0x30, 0x35, 0x37, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x64, 0x01, 0x01, 0x72, 0x62, 0x01, 0x08, 0x05, 0x00, 0x15, 0x3b,
         0x01, 0xec, 0x46, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x60, 0x04, 0xff, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x60,
         0x05, 0xff, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x60, 0x06, 0xff, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0x81, 0x60,
         0x08, 0xff, 0x01, 0x01, 0x63, 0xe8, 0xb8, 0x00

        });

    smf::sml::unpack p(
        [](std::string trx, std::uint8_t, std::uint8_t, smf::sml::msg_type type, cyng::tuple_t msg, std::uint16_t crc) {
            std::cout << "> " << smf::sml::get_name(type) << ": " << trx << ", " << msg << std::endl;
            cyng::io::serialize_pretty(std::cout, msg);
            std::cout << std::endl;
            if (type == smf::sml::msg_type::GET_PROC_PARAMETER_RESPONSE) {
                //  server, path, code, attribute, child list
                auto const [s, p, code, a, l] = smf::sml::read_get_proc_parameter_response(msg);
                auto const pm = smf::sml::compress(l);
                // cyng::io::serialize_json_pretty(std::cout, cyng::make_object(pm));
                // std::cout << std::endl;
                //   {
                //   "8181816001ff": null,
                //   "8181816002ff": null,
                //   "8181816003ff": { "818181600301": {
                //       "81818161ffff": "operator",
                //       "81818162ffff": "06e55b633481f7bb072957eabcf110c972e86691c3cfedabe088024bffe42f23",
                //       "81818163ffff": null,
                //       "818181640101": "0500153b01ec46",
                //       "818181640102": "3034303435303537",
                //       "818181640103": "0a000001",
                //       "818181640104": "0a000002",
                //       "818181640105": "0a000003",
                //       "818181640106": "0a000004",
                //       "818181640107": "0aa00001",
                //       "818181640108": "0ad00001",
                //       "818181640109": "0ae00001",
                //       "81818164010a": "01fa306dd7fae00102",
                //       "81818164010b": "0ab00001",
                //       "81818164010c": "012423021590200786",
                //       "81818164010d": "01a815743145040102",
                //       "81818164010e": "01e61e130900163c07",
                //       "81818164010f": "01e61e29436587bf03",
                //       "818181640110": "005056c00008",
                //       "818181640111": "01e61e571406213603"
                //     }
                //   },
                //   "8181816004ff": null,
                //   "8181816005ff": null,
                //   "8181816006ff": null,
                //   "8181816008ff": null
                // }
            }
        });
    p.read(std::begin(inp), std::end(inp));
}

BOOST_AUTO_TEST_CASE(get_proc_param_response_2) {
    auto const inp = cyng::make_buffer(
        {0x76, 0x81, 0x06, 0x32, 0x32, 0x30, 0x32, 0x30, 0x32, 0x32, 0x30, 0x34, 0x30, 0x34, 0x36, 0x38, 0x32, 0x36, 0x34, 0x38,
         0x39, 0x2d, 0x33, 0x62, 0x02, 0x62, 0x00, 0x72, 0x63, 0x05, 0x01, 0x73, 0x08, 0x05, 0x00, 0x15, 0x3b, 0x01, 0xec, 0x46,
         0x71, 0x07, 0x81, 0x81, 0x10, 0x06, 0xff, 0xff, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0xff, 0xff, 0x01, 0x71, 0x73, 0x07,
         0x81, 0x81, 0x10, 0x06, 0x01, 0xff, 0x01, 0xf1, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x01, 0x01, 0x73, 0x73,
         0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x05, 0x0a, 0x00, 0x00, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81,
         0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00,
         0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xdd, 0xf2, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x02,
         0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x05, 0x0a, 0x00, 0x00, 0x02, 0x01, 0x73,
         0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00,
         0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xdd, 0xf3, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10,
         0x06, 0x01, 0x03, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x05, 0x0a, 0x00, 0x00,
         0x03, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07,
         0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xdd, 0xf4, 0x01, 0x73, 0x07,
         0x81, 0x81, 0x10, 0x06, 0x01, 0x04, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x05,
         0x0a, 0x00, 0x00, 0x04, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d,
         0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xdd, 0xf5,
         0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x05, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72,
         0x62, 0x01, 0x05, 0x0a, 0xa0, 0x00, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04,
         0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61,
         0xfa, 0xdd, 0xf6, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x06, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82,
         0x04, 0xff, 0x72, 0x62, 0x01, 0x05, 0x0a, 0xb0, 0x00, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72,
         0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62,
         0x02, 0x65, 0x61, 0xfa, 0xdd, 0xf7, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x07, 0x01, 0x73, 0x73, 0x07, 0x81,
         0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x05, 0x0a, 0xd0, 0x00, 0x01, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82,
         0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62,
         0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xdd, 0xf8, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x08, 0x01, 0x73,
         0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x05, 0x0a, 0xe0, 0x00, 0x01, 0x01, 0x73, 0x07, 0x81,
         0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b,
         0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xdd, 0xf9, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01,
         0x09, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x07, 0x00, 0x50, 0x56, 0xc0, 0x00,
         0x08, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07,
         0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xde, 0x3f, 0x01, 0x73, 0x07,
         0x81, 0x81, 0x10, 0x06, 0x01, 0x0a, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x07,
         0x0b, 0x5c, 0x51, 0x8d, 0x72, 0xc1, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d,
         0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xf9,
         0x96, 0xa3, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x0b, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04,
         0xff, 0x72, 0x62, 0x01, 0x07, 0x33, 0xec, 0xef, 0x20, 0x88, 0xc1, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff,
         0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72,
         0x62, 0x02, 0x65, 0x61, 0xf9, 0x91, 0xbe, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x0c, 0x01, 0x73, 0x73, 0x07,
         0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x07, 0xa7, 0x06, 0x36, 0x71, 0x4e, 0xea, 0x01, 0x73, 0x07, 0x81,
         0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b,
         0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xf9, 0x90, 0x27, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01,
         0x0d, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x07, 0xb2, 0xc8, 0x68, 0x64, 0xad,
         0xa6, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07,
         0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xf9, 0x93, 0x50, 0x01, 0x73, 0x07,
         0x81, 0x81, 0x10, 0x06, 0x01, 0x0e, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x0a,
         0x01, 0x24, 0x23, 0x96, 0x07, 0x20, 0x00, 0x63, 0x0e, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62,
         0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02,
         0x65, 0x61, 0xfa, 0xde, 0x21, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x0f, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81,
         0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x0a, 0x01, 0xa8, 0x15, 0x74, 0x31, 0x45, 0x04, 0x01, 0x02, 0x01, 0x73, 0x07,
         0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09,
         0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xde, 0x38, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06,
         0x01, 0x10, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff, 0x72, 0x62, 0x01, 0x0a, 0x01, 0xe6, 0x1e, 0x13,
         0x09, 0x00, 0x16, 0x3c, 0x07, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d,
         0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62, 0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xdd,
         0x97, 0x01, 0x73, 0x07, 0x81, 0x81, 0x10, 0x06, 0x01, 0x11, 0x01, 0x73, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82, 0x04, 0xff,
         0x72, 0x62, 0x01, 0x0a, 0x01, 0xe6, 0x1e, 0x57, 0x14, 0x06, 0x21, 0x36, 0x03, 0x01, 0x73, 0x07, 0x81, 0x81, 0xc7, 0x82,
         0x02, 0xff, 0x72, 0x62, 0x01, 0x04, 0x2d, 0x2d, 0x2d, 0x01, 0x73, 0x07, 0x01, 0x00, 0x00, 0x09, 0x0b, 0x00, 0x72, 0x62,
         0x04, 0x72, 0x62, 0x02, 0x65, 0x61, 0xfa, 0xde, 0x18, 0x01, 0x63, 0xb5, 0x95, 0x00});

    smf::sml::unpack p(
        [](std::string trx, std::uint8_t, std::uint8_t, smf::sml::msg_type type, cyng::tuple_t msg, std::uint16_t crc) {
            std::cout << "> " << smf::sml::get_name(type) << ": " << trx << ", " << msg << std::endl;
            cyng::io::serialize_pretty(std::cout, msg);
            std::cout << std::endl;
            if (type == smf::sml::msg_type::GET_PROC_PARAMETER_RESPONSE) {
                auto const r = smf::sml::read_get_proc_parameter_response(msg);
                // for (auto const &ro : std::get<5>(r)) {
                //     std::cout << ">> " << ro.first << ": " << ro.second << std::endl;
                // }
            }
        });
    p.read(std::begin(inp), std::end(inp));
}

BOOST_AUTO_TEST_CASE(serializer) {

    std::stringstream os;
    //  139777dec = 022201hex
    {
        auto const size = cyng::io::serializer<std::uint32_t, cyng::io::SML>::write(os, 139777u);
        cyng::buffer_t r;
        r.resize(size);
        os.read(r.data(), size);
        BOOST_REQUIRE_EQUAL(r.size(), 4);
        BOOST_REQUIRE_EQUAL(r.at(0), 0x64); //  u32 data type
        BOOST_REQUIRE_EQUAL(r.at(1), 0x02);
        BOOST_REQUIRE_EQUAL(r.at(2), 0x22);
        BOOST_REQUIRE_EQUAL(r.at(3), 0x01);
    }

    //  20 bytes: 200208183520292288-2 == 81063230303230383138333532303239323238382D32
    // std::uint32_t s1 = 5;       //              - 0010
    // std::uint32_t s2 = 46;      //  0x2e        - 0010_1110
    // std::uint32_t s3 = 743;     //  0x2e7       - 0010_1110_0111
    // std::uint32_t s4 = 11900;   //  0x2e7C      - 0010_1110_0111_1100
    // std::uint32_t s5 = 190401;  //  0x2e7C1     - 0010_1110_0111_1100_0001
    // std::uint32_t s6 = 3046427; //  0x2e7C1B    - 0010_1110_0111_1100_0001_1011
    // std::vector<std::uint32_t> values = {
    //    0,
    //    6,     // 0 - - 0x07 - 7
    //    7,     // 0 - - 0x08 - 8
    //    14,    // 0
    //    15,    // X0
    //    20,    // X0 - 0x8106 - 129, 6
    //    743,   // XX0
    //    11900, // XXX0
    //    190401,
    //    3046427,
    //    0xFFFFFE,
    //    0xFFFFFF};

    // for (auto v : values) {
    //     // std::cout << v << ": " << +cyng::io::get_shift_count(v) << std::endl;
    //     std::cout << v << " - ";
    //     cyng::io::write_data_length_field(v, 0x00);
    //}

    {
        auto const r = cyng::io::write_data_length_field(7, 0x00);
        BOOST_REQUIRE_EQUAL(r.size(), 1);
        BOOST_CHECK_EQUAL(r.at(0), 8);
    }
    {
        auto const r = cyng::io::write_data_length_field(20, 0x00);
        BOOST_REQUIRE_EQUAL(r.size(), 2);
        BOOST_CHECK_EQUAL(r.at(0), 0x81);
        BOOST_CHECK_EQUAL(r.at(1), 0x06);
    }
    {
        auto const r = cyng::io::write_data_length_field(1062, 0x00);
        BOOST_REQUIRE_EQUAL(r.size(), 3);
        BOOST_CHECK_EQUAL(r.at(0), 0x84);
        BOOST_CHECK_EQUAL(r.at(1), 0x82);
        BOOST_CHECK_EQUAL(r.at(2), 0x09);
    }

    {
        //  [84][82][09] == 0x426 == 1062dec
        auto const inp = cyng::make_buffer(
            {0x2D, 0x2D, 0x2D, 0x2D, 0x2D, 0x42, 0x45, 0x47, 0x49, 0x4E, 0x20, 0x43, 0x45, 0x52, 0x54, 0x49, 0x46, 0x49, 0x43, 0x41,
             0x54, 0x45, 0x20, 0x52, 0x45, 0x51, 0x55, 0x45, 0x53, 0x54, 0x2D, 0x2D, 0x2D, 0x2D, 0x2D, 0x0A, 0x4D, 0x49, 0x49, 0x43,
             0x32, 0x44, 0x43, 0x43, 0x41, 0x63, 0x41, 0x43, 0x41, 0x51, 0x4D, 0x77, 0x52, 0x54, 0x45, 0x58, 0x4D, 0x42, 0x55, 0x47,
             0x41, 0x31, 0x55, 0x45, 0x41, 0x78, 0x4D, 0x4F, 0x4D, 0x44, 0x55, 0x77, 0x4D, 0x44, 0x45, 0x31, 0x4D, 0x30, 0x49, 0x77,
             0x4D, 0x6A, 0x49, 0x35, 0x4F, 0x44, 0x41, 0x78, 0x44, 0x7A, 0x41, 0x4E, 0x42, 0x67, 0x4E, 0x56, 0x42, 0x41, 0x6F, 0x54,
             0x0A, 0x42, 0x6C, 0x4E, 0x4E, 0x4C, 0x56, 0x42, 0x4C, 0x53, 0x54, 0x45, 0x4D, 0x4D, 0x41, 0x6F, 0x47, 0x41, 0x31, 0x55,
             0x45, 0x43, 0x78, 0x4D, 0x44, 0x52, 0x31, 0x64, 0x47, 0x4D, 0x51, 0x73, 0x77, 0x43, 0x51, 0x59, 0x44, 0x56, 0x51, 0x51,
             0x47, 0x45, 0x77, 0x4A, 0x45, 0x52, 0x54, 0x43, 0x43, 0x41, 0x53, 0x49, 0x77, 0x44, 0x51, 0x59, 0x4A, 0x4B, 0x6F, 0x5A,
             0x49, 0x68, 0x76, 0x63, 0x4E, 0x0A, 0x41, 0x51, 0x45, 0x42, 0x42, 0x51, 0x41, 0x44, 0x67, 0x67, 0x45, 0x50, 0x41, 0x44,
             0x43, 0x43, 0x41, 0x51, 0x6F, 0x43, 0x67, 0x67, 0x45, 0x42, 0x41, 0x4D, 0x4D, 0x42, 0x47, 0x4C, 0x56, 0x54, 0x6D, 0x4B,
             0x43, 0x79, 0x74, 0x7A, 0x4D, 0x5A, 0x52, 0x4E, 0x72, 0x6B, 0x34, 0x4F, 0x31, 0x58, 0x56, 0x79, 0x59, 0x48, 0x61, 0x63,
             0x66, 0x33, 0x7A, 0x62, 0x43, 0x4B, 0x75, 0x57, 0x68, 0x4E, 0x0A, 0x4A, 0x4C, 0x6D, 0x70, 0x56, 0x77, 0x35, 0x34, 0x50,
             0x5A, 0x79, 0x6A, 0x47, 0x69, 0x7A, 0x36, 0x44, 0x44, 0x42, 0x55, 0x55, 0x6B, 0x70, 0x73, 0x6C, 0x48, 0x54, 0x4F, 0x77,
             0x66, 0x45, 0x44, 0x76, 0x32, 0x66, 0x36, 0x72, 0x53, 0x6A, 0x44, 0x30, 0x72, 0x52, 0x43, 0x46, 0x31, 0x57, 0x30, 0x59,
             0x4D, 0x69, 0x62, 0x2B, 0x35, 0x46, 0x6A, 0x45, 0x31, 0x50, 0x67, 0x2F, 0x36, 0x76, 0x65, 0x0A, 0x6C, 0x4C, 0x79, 0x59,
             0x4D, 0x71, 0x78, 0x76, 0x33, 0x49, 0x75, 0x4E, 0x73, 0x2B, 0x35, 0x62, 0x54, 0x77, 0x2B, 0x44, 0x59, 0x74, 0x76, 0x33,
             0x6C, 0x62, 0x6A, 0x77, 0x63, 0x55, 0x7A, 0x57, 0x74, 0x58, 0x58, 0x7A, 0x73, 0x79, 0x46, 0x41, 0x53, 0x62, 0x59, 0x55,
             0x64, 0x54, 0x35, 0x2B, 0x4A, 0x74, 0x47, 0x59, 0x36, 0x35, 0x63, 0x4D, 0x48, 0x57, 0x76, 0x4F, 0x2B, 0x30, 0x36, 0x72,
             0x0A, 0x53, 0x59, 0x30, 0x36, 0x6D, 0x6B, 0x44, 0x57, 0x49, 0x34, 0x31, 0x56, 0x33, 0x37, 0x67, 0x75, 0x50, 0x4F, 0x78,
             0x34, 0x55, 0x6B, 0x2B, 0x46, 0x78, 0x59, 0x56, 0x58, 0x48, 0x65, 0x6D, 0x57, 0x78, 0x68, 0x6E, 0x51, 0x57, 0x6F, 0x38,
             0x5A, 0x47, 0x49, 0x4A, 0x32, 0x78, 0x51, 0x67, 0x57, 0x30, 0x62, 0x32, 0x79, 0x46, 0x39, 0x4C, 0x4E, 0x65, 0x79, 0x4C,
             0x42, 0x61, 0x65, 0x31, 0x74, 0x0A, 0x73, 0x6A, 0x4B, 0x4D, 0x68, 0x4B, 0x55, 0x62, 0x41, 0x51, 0x4A, 0x37, 0x49, 0x44,
             0x5A, 0x69, 0x4E, 0x65, 0x6D, 0x34, 0x37, 0x31, 0x6B, 0x2B, 0x41, 0x51, 0x59, 0x48, 0x45, 0x45, 0x48, 0x71, 0x45, 0x59,
             0x48, 0x49, 0x6D, 0x49, 0x6F, 0x45, 0x5A, 0x34, 0x35, 0x56, 0x50, 0x4E, 0x43, 0x54, 0x52, 0x6D, 0x72, 0x55, 0x63, 0x6D,
             0x4D, 0x50, 0x69, 0x7A, 0x4E, 0x59, 0x4F, 0x6B, 0x58, 0x51, 0x0A, 0x63, 0x63, 0x6F, 0x6F, 0x48, 0x6C, 0x50, 0x31, 0x78,
             0x2F, 0x37, 0x53, 0x43, 0x38, 0x7A, 0x6C, 0x64, 0x78, 0x45, 0x4F, 0x31, 0x41, 0x56, 0x4B, 0x45, 0x70, 0x4F, 0x75, 0x2B,
             0x38, 0x51, 0x70, 0x74, 0x6F, 0x48, 0x4A, 0x55, 0x61, 0x72, 0x70, 0x79, 0x44, 0x41, 0x5A, 0x69, 0x44, 0x4D, 0x43, 0x41,
             0x77, 0x45, 0x41, 0x41, 0x61, 0x42, 0x4F, 0x4D, 0x45, 0x77, 0x47, 0x43, 0x53, 0x71, 0x47, 0x0A, 0x53, 0x49, 0x62, 0x33,
             0x44, 0x51, 0x45, 0x4A, 0x44, 0x6A, 0x45, 0x2F, 0x4D, 0x44, 0x30, 0x77, 0x44, 0x67, 0x59, 0x44, 0x56, 0x52, 0x30, 0x50,
             0x41, 0x51, 0x48, 0x2F, 0x42, 0x41, 0x51, 0x44, 0x41, 0x67, 0x65, 0x41, 0x4D, 0x41, 0x77, 0x47, 0x41, 0x31, 0x55, 0x64,
             0x45, 0x77, 0x45, 0x42, 0x2F, 0x77, 0x51, 0x43, 0x4D, 0x41, 0x41, 0x77, 0x48, 0x51, 0x59, 0x44, 0x56, 0x52, 0x30, 0x6C,
             0x0A, 0x42, 0x42, 0x59, 0x77, 0x46, 0x41, 0x59, 0x49, 0x4B, 0x77, 0x59, 0x42, 0x42, 0x51, 0x55, 0x48, 0x41, 0x77, 0x49,
             0x47, 0x43, 0x43, 0x73, 0x47, 0x41, 0x51, 0x55, 0x46, 0x42, 0x77, 0x4D, 0x42, 0x4D, 0x41, 0x30, 0x47, 0x43, 0x53, 0x71,
             0x47, 0x53, 0x49, 0x62, 0x33, 0x44, 0x51, 0x45, 0x42, 0x43, 0x77, 0x55, 0x41, 0x41, 0x34, 0x49, 0x42, 0x41, 0x51, 0x41,
             0x74, 0x63, 0x78, 0x64, 0x34, 0x0A, 0x4B, 0x52, 0x36, 0x73, 0x48, 0x2F, 0x56, 0x78, 0x44, 0x43, 0x68, 0x77, 0x51, 0x44,
             0x6E, 0x5A, 0x48, 0x73, 0x32, 0x51, 0x37, 0x74, 0x67, 0x67, 0x62, 0x2F, 0x63, 0x6A, 0x45, 0x6F, 0x2F, 0x44, 0x32, 0x74,
             0x6A, 0x69, 0x38, 0x59, 0x45, 0x2B, 0x4C, 0x46, 0x36, 0x76, 0x57, 0x42, 0x73, 0x53, 0x54, 0x63, 0x48, 0x6A, 0x43, 0x42,
             0x74, 0x66, 0x36, 0x71, 0x73, 0x76, 0x2B, 0x7A, 0x76, 0x33, 0x0A, 0x4A, 0x48, 0x36, 0x77, 0x71, 0x63, 0x70, 0x34, 0x65,
             0x42, 0x6C, 0x73, 0x56, 0x64, 0x31, 0x42, 0x43, 0x41, 0x4F, 0x69, 0x62, 0x77, 0x52, 0x6E, 0x75, 0x56, 0x74, 0x77, 0x66,
             0x6D, 0x61, 0x45, 0x41, 0x73, 0x38, 0x79, 0x70, 0x79, 0x78, 0x75, 0x61, 0x4E, 0x54, 0x2F, 0x2F, 0x49, 0x6F, 0x38, 0x46,
             0x65, 0x54, 0x7A, 0x62, 0x64, 0x39, 0x66, 0x39, 0x35, 0x63, 0x50, 0x4E, 0x61, 0x65, 0x52, 0x0A, 0x41, 0x6C, 0x78, 0x37,
             0x50, 0x5A, 0x7A, 0x4D, 0x34, 0x42, 0x35, 0x6D, 0x36, 0x33, 0x78, 0x49, 0x46, 0x6A, 0x69, 0x52, 0x63, 0x52, 0x6F, 0x33,
             0x34, 0x6B, 0x51, 0x38, 0x72, 0x4E, 0x63, 0x57, 0x6F, 0x61, 0x4A, 0x55, 0x4D, 0x52, 0x74, 0x64, 0x35, 0x73, 0x2F, 0x48,
             0x7A, 0x4C, 0x54, 0x4B, 0x33, 0x6E, 0x78, 0x6E, 0x55, 0x58, 0x38, 0x2B, 0x64, 0x6F, 0x62, 0x70, 0x65, 0x73, 0x65, 0x70,
             0x0A, 0x52, 0x7A, 0x79, 0x45, 0x65, 0x78, 0x42, 0x33, 0x39, 0x74, 0x43, 0x43, 0x62, 0x4B, 0x59, 0x32, 0x42, 0x58, 0x4A,
             0x71, 0x78, 0x36, 0x55, 0x7A, 0x74, 0x65, 0x2B, 0x44, 0x6F, 0x42, 0x39, 0x77, 0x66, 0x66, 0x70, 0x71, 0x72, 0x71, 0x5A,
             0x7A, 0x76, 0x54, 0x77, 0x2F, 0x7A, 0x6D, 0x54, 0x7A, 0x61, 0x38, 0x31, 0x49, 0x36, 0x36, 0x62, 0x67, 0x41, 0x57, 0x44,
             0x35, 0x72, 0x32, 0x4C, 0x49, 0x0A, 0x66, 0x67, 0x39, 0x6B, 0x6A, 0x55, 0x64, 0x6A, 0x34, 0x34, 0x33, 0x63, 0x6F, 0x67,
             0x41, 0x38, 0x38, 0x64, 0x4E, 0x74, 0x61, 0x32, 0x44, 0x4A, 0x39, 0x7A, 0x45, 0x4C, 0x45, 0x4F, 0x71, 0x33, 0x51, 0x43,
             0x4C, 0x69, 0x2B, 0x65, 0x33, 0x31, 0x69, 0x56, 0x51, 0x53, 0x6F, 0x51, 0x62, 0x68, 0x72, 0x31, 0x69, 0x51, 0x6E, 0x33,
             0x35, 0x2F, 0x47, 0x73, 0x78, 0x4D, 0x30, 0x31, 0x6F, 0x6C, 0x0A, 0x65, 0x47, 0x37, 0x42, 0x61, 0x48, 0x75, 0x48, 0x73,
             0x2B, 0x64, 0x38, 0x33, 0x34, 0x71, 0x55, 0x0A, 0x2D, 0x2D, 0x2D, 0x2D, 0x2D, 0x45, 0x4E, 0x44, 0x20, 0x43, 0x45, 0x52,
             0x54, 0x49, 0x46, 0x49, 0x43, 0x41, 0x54, 0x45, 0x20, 0x52, 0x45, 0x51, 0x55, 0x45, 0x53, 0x54, 0x2D, 0x2D, 0x2D, 0x2D,
             0x2D, 0x0A});

        // std::cout << inp.size() << std::endl;
        auto const size = cyng::io::serializer<cyng::buffer_t, cyng::io::SML>::write(os, inp);
        cyng::buffer_t r;
        r.resize(size);
        os.read(r.data(), size);
        // BOOST_REQUIRE_EQUAL(r.size(), 4);
        // BOOST_REQUIRE_EQUAL(r.at(0), 0x64); //  u32 data type
        // BOOST_REQUIRE_EQUAL(r.at(1), 0x02);
        // BOOST_REQUIRE_EQUAL(r.at(2), 0x22);
        // BOOST_REQUIRE_EQUAL(r.at(3), 0x01);
    }
}

BOOST_AUTO_TEST_CASE(generator) {
    smf::sml::response_generator res_gen;

    auto const file_id = cyng::hex_to_buffer("21070521492320490-1b");
    auto const client = cyng::hex_to_buffer("005056C00008");

    {
        smf::sml::messages_t msgs;
        msgs.push_back(res_gen.public_open("21042716170468656-1", file_id, client, "0500153B01EC46"));
        auto const buffer = smf::sml::to_sml(msgs);

#ifdef _DEBUG
        {
            std::stringstream ss;
            cyng::io::hex_dump<8> hd;
            hd(ss, std::begin(buffer), std::end(buffer));
            auto const dmp = ss.str();
            std::cerr << "response " << buffer.size() << " bytes:\n" << dmp;
        }
#endif
        BOOST_REQUIRE_EQUAL(buffer.size(), 0x4c);
        BOOST_REQUIRE_EQUAL(buffer.at(0x38), 0);
    }
    auto const server = cyng::hex_to_buffer("0500153B022980");
    {
        auto const path = cyng::make_obis_path(cyng::hex_to_buffer("8148170700FF"));
        smf::sml::messages_t msgs;
        msgs.push_back(res_gen.get_proc_parameter(
            "21042716170468656-1", server, path, smf::sml::tree_param(path.front(), smf::sml::make_value(1234))));
        auto const buffer = smf::sml::to_sml(msgs);
#ifdef _DEBUG
        {
            std::stringstream ss;
            cyng::io::hex_dump<8> hd;
            hd(ss, std::begin(buffer), std::end(buffer));
            auto const dmp = ss.str();
            std::cerr << "response " << buffer.size() << " bytes:\n" << dmp;
        }
#endif
    }

    {
        smf::sml::request_generator req_gen("operator", "operator");
        auto req = req_gen.get_proc_parameter_access(server, 3, 1, 0x01a0);
#ifdef _DEBUG
        cyng::io::serialize_json_pretty(std::cout, req);
#endif
        BOOST_CHECK_EQUAL(req.size(), 6);
    }
}

BOOST_AUTO_TEST_CASE(select) {
    //
    //  simulate output from SML parser
    //
    auto const msg = cyng::make_tuple(smf::sml::tree_child_list(
        cyng::make_obis(0x81, 0x81, 0x11, 0x06, 0x01, 0xFF),
        cyng::make_tuple(
            smf::sml::tree_child_list(
                cyng::make_obis(0x81, 0x81, 0x11, 0x06, 0x01, 0x01),
                //  list of devices
                //  1. device
                cyng::make_tuple(
                    smf::sml::tree_param(
                        smf::OBIS_SERVER_ID,
                        cyng::make_attr(1, cyng::make_buffer({0x01, 0xA8, 0x15, 0x74, 0x31, 0x45, 0x04, 0x01, 0x02}))),
                    smf::sml::tree_param(smf::OBIS_DEVICE_CLASS, cyng::make_attr(1, "---")),
                    smf::sml::tree_param(smf::OBIS_CURRENT_UTC, cyng::make_attr(4, std::chrono::system_clock::now())))),
            //  2. device
            smf::sml::tree_child_list(
                cyng::make_obis(0x81, 0x81, 0x11, 0x06, 0x01, 0x02),
                //  list of devices
                cyng::make_tuple(
                    smf::sml::tree_param(
                        smf::OBIS_SERVER_ID,
                        cyng::make_attr(1, cyng::make_buffer({0x01, 0xE6, 0x1E, 0x57, 0x14, 0x06, 0x21, 0x36, 0x03}))),
                    smf::sml::tree_param(smf::OBIS_DEVICE_CLASS, cyng::make_attr(1, "+++")),
                    smf::sml::tree_param(smf::OBIS_CURRENT_UTC, cyng::make_attr(4, std::chrono::system_clock::now())))))));

    cyng::io::serialize_pretty(std::cout, msg);
    std::cout << std::endl;
    // std::cout << cyng::io::to_pretty(msg) << std::endl;
    // smf::sml::select_devices(msg);
    smf::sml::select(msg, smf::OBIS_ROOT_ACTIVE_DEVICES, [](cyng::prop_map_t const &om, std::size_t idx) {
        std::cerr << '#' << idx << " - " << om << std::endl;
    });
}

BOOST_AUTO_TEST_CASE(status) {

    //  01110010001000000010 - offline
    //  01110000001000000010 - online
    //
    //  SERVICE_IF_AVAILABLE = true
    //  EXT_IF_AVAILABLE = true
    //  WIRELESS_MBUS_IF_AVAILABLE = true
    //  NO_TIMEBASE = false
    //
    smf::sml::status_word_t word = 0x70202;
    auto const pm = smf::sml::to_param_map(word);
    BOOST_REQUIRE_EQUAL(pm.size(), 9);

    auto pos = pm.find(smf::sml::get_name(smf::sml::status_bit::FATAL_ERROR));
    BOOST_REQUIRE(pos != pm.end());
    if (pos != pm.end()) {
        BOOST_REQUIRE(!cyng::value_cast(pos->second, true));
    }

    pos = pm.find("AUTHORIZED_IPT");
    BOOST_REQUIRE(pos != pm.end());
    if (pos != pm.end()) {
        BOOST_REQUIRE(cyng::value_cast(pos->second, false));
    }

    pos = pm.find(smf::sml::get_name(smf::sml::status_bit::SERVICE_IF_AVAILABLE));
    BOOST_REQUIRE(pos != pm.end());
    if (pos != pm.end()) {
        BOOST_REQUIRE(cyng::value_cast(pos->second, false));
    }

    pos = pm.find(smf::sml::get_name(smf::sml::status_bit::EXT_IF_AVAILABLE));
    BOOST_REQUIRE(pos != pm.end());
    if (pos != pm.end()) {
        BOOST_REQUIRE(cyng::value_cast(pos->second, false));
    }

    pos = pm.find(smf::sml::get_name(smf::sml::status_bit::WIRELESS_MBUS_IF_AVAILABLE));
    BOOST_REQUIRE(pos != pm.end());
    if (pos != pm.end()) {
        BOOST_REQUIRE(cyng::value_cast(pos->second, false));
    }

    pos = pm.find(smf::sml::get_name(smf::sml::status_bit::PLC_AVAILABLE));
    BOOST_REQUIRE(pos != pm.end());
    if (pos != pm.end()) {
        BOOST_REQUIRE(!cyng::value_cast(pos->second, true));
    }

    // std::cerr << pm << std::endl;

    //  %(
    //      ("AUTHORIZED_IPT":true),
    //      ("EXT_IF_AVAILABLE":true),
    //      ("FATAL_ERROR":false),
    //      ("NO_TIMEBASE":false),
    //      ("OUT_OF_MEMORY":false),
    //      ("PLC_AVAILABLE":false),
    //      ("SERVICE_IF_AVAILABLE":true),
    //      ("WIRED_MBUS_IF_AVAILABLE":false),
    //      ("WIRELESS_BUS_IF_AVAILABLE":true)
    //  )
}

BOOST_AUTO_TEST_SUITE_END()
